import{e as c,R as C,d as b,M as k,W as y,l as f}from"./index-296cb957.js";var v=globalThis&&globalThis.__awaiter||function(l,t,s,o){function r(n){return n instanceof s?n:new s(function(e){e(n)})}return new(s||(s=Promise))(function(n,e){function i(d){try{u(o.next(d))}catch(p){e(p)}}function a(d){try{u(o.throw(d))}catch(p){e(p)}}function u(d){d.done?n(d.value):r(d.value).then(i,a)}u((o=o.apply(l,t||[])).next())})};class w{constructor(t,s,o){this._languageId=t,this._worker=s,this._defaults=o,this._disposables=[],this._listener=Object.create(null);const r=e=>{let i=e.getLanguageId();i===this._languageId&&(this._listener[e.uri.toString()]=e.onDidChangeContent(b(()=>{this._doValidate(e.uri,i)},500)),this._doValidate(e.uri,i))},n=e=>{c.setModelMarkers(e,this._languageId,[]);let i=e.uri.toString(),a=this._listener[i];a&&(a.dispose(),delete this._listener[i])};this._disposables.push(c.onDidCreateModel(r)),this._disposables.push(c.onWillDisposeModel(n)),this._disposables.push(c.onDidChangeModelLanguage(e=>{n(e.model),r(e.model)})),this._disposables.push(this._defaults.onDidChange(e=>{c.getModels().forEach(i=>{i.getLanguageId()===this._languageId&&(n(i),r(i))})})),this._disposables.push({dispose:()=>{for(let e in this._listener)this._listener[e].dispose()}}),c.getModels().forEach(r)}dispose(){this._disposables.forEach(t=>t&&t.dispose()),this._disposables=[]}_doValidate(t,s){this._worker(t).then(o=>{var r;let n=((r=c.getModel(t))===null||r===void 0?void 0:r.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(n=this._defaults.preprocessCode(n)),o.doValidation(n)}).then(o=>{const r=o.map(e=>M(t,e));let n=c.getModel(t);n&&n.getLanguageId()===s&&c.setModelMarkers(n,s,r)}).then(void 0,o=>{console.error(o)})}}function I(l){switch(l){default:return k.Error}}function M(l,t){return{severity:I(),startLineNumber:t.startLine,startColumn:t.startColumn,endLineNumber:t.endLine,endColumn:t.endColumn,message:t.message,code:void 0,source:"dt-sql-parser"}}function S(l,t){const s=l.getValueInRange(new C(0,0,t.lineNumber,t.column)),o=s.lastIndexOf(";");return o===-1?s:s.slice(o+1)}class T{constructor(t,s){this._worker=t,this._defaults=s}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(t,s,o,r){const n=t.uri;return this._worker(n).then(e=>{var i;let a=((i=c.getModel(n))===null||i===void 0?void 0:i.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(a=this._defaults.preprocessCode(a)),e.doCompletionWithEntities(a,s)}).then(({suggestions:e,allEntities:i,context:a})=>v(this,void 0,void 0,function*(){let u=[];return a!=null&&a.newStatement&&(u=this._defaults.completionSnippets.map(d=>Object.assign(Object.assign({},d),{insertText:typeof d.body=="string"?d.body:d.body.join(`
`)}))),this._defaults.completionService(t,s,o,e,i,u)})).then(e=>{const i=t.getWordUntilPosition(s),a=new C(s.lineNumber,i.startColumn,s.lineNumber,i.endColumn);return{suggestions:(Array.isArray(e)?e:e.suggestions).map(p=>{var h,g;return Object.assign(Object.assign({},p),{insertText:(h=p.insertText)!==null&&h!==void 0?h:typeof p.label=="string"?p.label:p.label.label,range:(g=p.range)!==null&&g!==void 0?g:a})}),dispose:Array.isArray(e)?void 0:e.dispose,incomplete:Array.isArray(e)?void 0:e.incomplete}})}}class A{constructor(t,s){this._worker=t,this._defaults=s,this.allSnippetsTokens=[],console.log("模板列表",s.inlineCompletionSnippets)}provideInlineCompletions(t,s){const o=t.uri;return this._worker(o).then(r=>v(this,void 0,void 0,function*(){var n;let e=S(t,s);if(typeof this._defaults.preprocessCode=="function"&&(e=this._defaults.preprocessCode(e)),!(!((n=this.allSnippetsTokens)===null||n===void 0)&&n.length)){const a=[];for(const u of this._defaults.inlineCompletionSnippets){const d=yield r.getAllTokens(u);a.push({tokens:d,snippetText:u})}this.allSnippetsTokens=a}const i=yield r.getAllTokens(e);return{code:e,codeTokens:i,allSnippetsTokens:this.allSnippetsTokens}})).then(({code:r,codeTokens:n,allSnippetsTokens:e})=>this._defaults.inlineCompletionService(t,s,r,n,e))}freeInlineCompletions(t){}}function x(l){const t=[],s=[],o=new y(l);t.push(o);const r=(...e)=>o.getLanguageServiceWorker(...e);function n(){const{languageId:e,modeConfiguration:i}=l;m(s),i.diagnostics&&s.push(new w(e,r,l)),i.completionItems.enable&&s.push(f.registerCompletionItemProvider(e,new T(r,l))),i.inlineCompletionItems.enable&&s.push(f.registerInlineCompletionsProvider(e,new A(r,l)))}return n(),t.push(_(s)),_(t)}function _(l){return{dispose:()=>m(l)}}function m(l){for(var t;l.length;)(t=l.pop())===null||t===void 0||t.dispose()}export{x as setupLanguageMode};
