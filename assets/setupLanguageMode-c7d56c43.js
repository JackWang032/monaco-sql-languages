import{e as d,R as b,M as v,W as C,l as m}from"./index-90b6a8bb.js";function y(r,t,n){let i=null;return(...o)=>{if(i&&clearTimeout(i),n&&!i)return r==null?void 0:r(...o);i=setTimeout(()=>{i&&clearTimeout(i),i=null,r==null||r(...o)},t)}}class M{constructor(t,n,i){this._languageId=t,this._worker=n,this._defaults=i,this._disposables=[],this._listener=Object.create(null);const o=e=>{let s=e.getLanguageId();s===this._languageId&&(this._listener[e.uri.toString()]=e.onDidChangeContent(y(()=>{this._doValidate(e.uri,s)},500)),this._doValidate(e.uri,s))},a=e=>{d.setModelMarkers(e,this._languageId,[]);let s=e.uri.toString(),l=this._listener[s];l&&(l.dispose(),delete this._listener[s])};this._disposables.push(d.onDidCreateModel(o)),this._disposables.push(d.onWillDisposeModel(a)),this._disposables.push(d.onDidChangeModelLanguage(e=>{a(e.model),o(e.model)})),this._disposables.push(this._defaults.onDidChange(e=>{d.getModels().forEach(s=>{s.getLanguageId()===this._languageId&&(a(s),o(s))})})),this._disposables.push({dispose:()=>{for(let e in this._listener)this._listener[e].dispose()}}),d.getModels().forEach(o)}dispose(){this._disposables.forEach(t=>t&&t.dispose()),this._disposables=[]}_doValidate(t,n){this._worker(t).then(i=>{var o;let a=((o=d.getModel(t))===null||o===void 0?void 0:o.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(a=this._defaults.preprocessCode(a)),i.doValidation(a)}).then(i=>{const o=i.map(e=>I(t,e));let a=d.getModel(t);a&&a.getLanguageId()===n&&d.setModelMarkers(a,n,o)}).then(void 0,i=>{console.error(i)})}}function w(r){switch(r){default:return v.Error}}function I(r,t){return{severity:w(),startLineNumber:t.startLine,startColumn:t.startColumn,endLineNumber:t.endLine,endColumn:t.endColumn,message:t.message,code:void 0,source:"dt-sql-parser"}}class k{constructor(t,n){this._worker=t,this._defaults=n}get triggerCharacters(){return Array.isArray(this._defaults.triggerCharacters)?this._defaults.triggerCharacters:["."," "]}provideCompletionItems(t,n,i,o){const a=t.uri;return this._worker(a).then(e=>{var s;let l=((s=d.getModel(a))===null||s===void 0?void 0:s.getValue())||"";return typeof this._defaults.preprocessCode=="function"&&(l=this._defaults.preprocessCode(l)),e.doCompletionWithEntities(l,n)}).then(({suggestions:e,allEntities:s,context:l})=>{let p=[];return l!=null&&l.isStatementBeginning&&(p=this._defaults.completionSnippets.map(g=>Object.assign(Object.assign({},g),{insertText:typeof g.body=="string"?g.body:g.body.join(`
`)}))),this._defaults.completionService(t,n,i,e,s,p)}).then(e=>{const s=t.getWordUntilPosition(n),l=new b(n.lineNumber,s.startColumn,n.lineNumber,s.endColumn);return{suggestions:(Array.isArray(e)?e:e.suggestions).map(u=>{var h,c;return Object.assign(Object.assign({},u),{insertText:(h=u.insertText)!==null&&h!==void 0?h:typeof u.label=="string"?u.label:u.label.label,range:(c=u.range)!==null&&c!==void 0?c:l})}),dispose:Array.isArray(e)?void 0:e.dispose,incomplete:Array.isArray(e)?void 0:e.incomplete}})}}function L(r){const t=[],n=[],i=new C(r);t.push(i);const o=(...e)=>i.getLanguageServiceWorker(...e);function a(){const{languageId:e,modeConfiguration:s}=r;f(n),s.diagnostics&&n.push(new M(e,o,r)),s.completionItems.enable&&n.push(m.registerCompletionItemProvider(e,new k(o,r)))}return a(),t.push(_(n)),_(t)}function _(r){return{dispose:()=>f(r)}}function f(r){for(var t;r.length;)(t=r.pop())===null||t===void 0||t.dispose()}export{L as setupLanguageMode};
